# 认证服务技术方案

## 背景与目标
- 为前后端分离提供登录、注册、令牌签发/刷新、登出与权限校验能力。
- 统一鉴权模型，支持角色/资源粒度的访问控制，接入网关与各微服务。

## 技术选型
- `Spring Security` + 自定义过滤器链；`jjwt`（或 `Nimbus JOSE`）生成/解析 JWT。
- `Redis` 存储登录态（黑名单/会话/验证码/令牌旋转标记）。
- `BCrypt` 密码哈希；`Nacos` 服务发现与配置。

## 令牌与会话设计
- `Access Token`（JWT、短期、包含用户ID/角色/租户/签发时间）。
- `Refresh Token`（长效、仅用于刷新、绑定设备/客户端指纹）。
- 令牌旋转：刷新时签发新 Refresh Token，旧的加入黑名单。
- 支持服务端踢出（将当前 Access/Refresh Token 加入 Redis 黑名单）。

## 接口设计（示例）
- `POST /auth/login`：用户名/短信/邮箱/三方登录；返回 `access_token` 与 `refresh_token`。
- `POST /auth/refresh`：使用 `refresh_token` 获取新的 `access_token`。
- `POST /auth/logout`：登出并加入黑名单。
- `POST /auth/register`：注册并初始化默认角色。
- `GET /auth/profile`：返回当前用户基本信息与角色。

## 权限模型
- 角色-资源-动作（RBAC）：`role -> permission(resource, action)`。
- 细粒度控制（如订单仅限创建者或管理员可读写）。

## 安全策略
- 强制 HTTPS（生产）；签名密钥与过期时间走配置中心。
- 失败次数限制与滑动窗口；验证码/二次校验（可选）。
- 防重放：令牌 `jti` + Redis 记录；防 CSRF（使用 Bearer + SameSite）。

## 集成与网关
- 网关对 `/api/auth/**` 白名单开放 `login/refresh/register/ping`。
- 网关鉴权过滤器校验 `Authorization: Bearer <token>`，下游获取 `X-User-Id` 等头。

## 数据模型（简要）
- `user(id, username, password_hash, phone, email, status, created_at)`
- `user_role(user_id, role)`，`role_perm(role, resource, action)`
- `login_log(user_id, client_ip, ua, success, created_at)`

## 验收标准
- 覆盖 `login/refresh/logout/profile/register` 的单元与集成测试。
- 令牌旋转与黑名单有效；网关与下游能够识别用户身份。