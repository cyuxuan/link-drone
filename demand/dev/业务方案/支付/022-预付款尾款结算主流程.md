# 022-预付款尾款结算主流程

本流程定义订单资金流从预付款到尾款与结算的主路径，保障资金安全与对账一致。

## 1. 目标与范围
- 建立预付款担保（托管/冻结）机制与里程碑结算规则。
- 支持多支付渠道与对账，降低资金风险。

## 2. 参与角色
- 需求方：支付预付款与尾款。
- 供给方：履约完成后收款结算。
- 财务/系统：支付网关对接、资金托管与对账。

## 3. 前置条件
- 已配置预付款比例、渠道（微信/支付宝/银联等）与回调通知。
- 对接托管/分账方案（平台抽佣、税费处理）。

## 4. 主流程
1) 预付款
- 订单确认后生成预付款支付单；需求方支付，网关回调确认。
- 系统托管/冻结预付款，订单状态 `prepaid`。

2) 里程碑与尾款
- 履约里程碑完成后触发尾款支付单；需求方支付成功后进入结算。
- 如有部分里程碑/变更，则调整尾款金额与结算方案。

3) 结算与分账
- 系统对订单核算抽佣与税费，触发分账与结算到供给方账户。
- 生成结算单与对账记录，供财务审核。

## 5. 状态与事件
- 事件：`PrepayPending`、`PrepayPaid`、`MilestoneCompleted`、`FinalPayPaid`、`SettlementCompleted`。

## 6. 接口映射（示例）
- `POST /api/payments/orders/{id}/prepay` 预付款下单
- `POST /api/payments/orders/{id}/finalpay` 尾款下单
- `POST /api/payments/callback` 网关回调
- `POST /api/payments/settlement/{id}` 结算

## 7. 数据与校验
- 模型：`payment_order`、`payment_transaction`、`payment_settlement`、`ledger`。
- 校验：重复回调防重、金额一致性、分账比例、税费规则。

## 8. 异常与回滚
- 回调未达：重试与人工对账；暂不推进状态机。
- 金额不符：拦截并触发人工核查。
- 尾款拒付：进入争议处理或部分结算方案。

## 9. 审计与合规
- 审计：交易流水、分账记录、税费明细、对账差异。
- 合规：支付合规要求、用户资金安全与隐私保护。

## 10. 验收标准
- 预付款-尾款-结算闭环用例通过；
- 回调防重与金额一致性验证；分账/税费计算准确；
- 对账无差异或可解释差异，异常用例处理有回退与审计。