# 023-退款与对账主流程

本流程定义订单在取消/异常情况下的退款处理，以及日常对账闭环，确保资金安全与账务一致。

## 1. 目标与范围
- 支持部分/全额退款与多通道退款策略。
- 建立自动化对账与差异处理清单，降低人工成本。

## 2. 参与角色
- 需求方/供给方：发起退款申请、查看进度。
- 财务/系统：审核退款、执行退款、完成对账。

## 3. 前置条件
- 已配置退款政策与时限、渠道退款能力与回调。
- 对账周期与口径明确（T+1/T+3），支持异常清单导出。

## 4. 主流程
1) 退款申请与审核
- 发起退款申请，系统根据政策计算预估退款金额与扣费。
- 财务审核通过后，生成退款单并调用网关退款。

2) 网关回调与资金入账
- 接收退款回调与异步通知，更新退款状态并写入审计。
- 用户账户或原渠道入账；异常回滚或转入人工处理。

3) 对账与差异处理
- 按周期与口径拉取网关流水，对比平台流水与账本。
- 生成差异清单并自动归因（回调延迟、金额不符、渠道异常）。
- 自动重试或转人工核查，直至清零。

## 5. 状态与事件
- 状态：`refund_requested` → `refund_approved` → `refunding` → `refunded` → `reconcilied`。
- 事件：`RefundRequested`、`RefundApproved`、`RefundProcessed`、`ReconCompleted`。

## 6. 接口映射（示例）
- `POST /api/refunds/orders/{id}` 发起退款
- `POST /api/refunds/{id}/approve` 审核通过
- `POST /api/refunds/callback` 退款回调
- `POST /api/recon/run` 触发对账

## 7. 数据与校验
- 模型：`refund_order`、`refund_transaction`、`reconciliation_task`、`reconciliation_diff`。
- 校验：金额一致性、订单状态与政策匹配、回调防重、幂等保障。

## 8. 异常与回滚
- 回调延迟：保持中间态并重试拉取；过时转人工处理。
- 渠道失败：重试与切换渠道；必要时线下退款与备注。

## 9. 审计与合规
- 审计：退款原因、审核人、回调流水、差异处理、最终凭证。
- 合规：资金安全、隐私保护、账务合规、税务处理记录。

## 10. 验收标准
- 退款-回调-对账闭环用例通过；差异归因与消解完整。
- 异常场景（渠道失败、回调延迟、金额不符）有清晰回退与记录。