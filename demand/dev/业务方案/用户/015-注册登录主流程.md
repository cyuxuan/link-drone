# 015-注册登录主流程

参考《无人机供需撮合平台技术方案文档_v1》，本流程文件从业务视角拆解用户注册、登录（含刷新、登出）的主路径与关键校验，覆盖参与角色、前置条件、状态与事件、接口映射、异常与回滚、审计与验收标准。

## 1. 目标与范围
- 建立统一的注册与登录体验，支持手机号/邮箱/第三方登录。
- 提供基于 `AccessToken + RefreshToken` 的会话机制，满足移动端与管理后台一致的安全策略。
- 与后续实名/资质认证、订单及支付等主流程顺畅衔接。

## 2. 参与角色
- 访客：未登录用户，发起注册或登录。
- 普通用户（供给方/需求方）：完成注册并登录后进行后续业务动作。
- 管理员（运营）：查看登录审计、拉黑/解封账号，协助风控。

## 3. 前置条件
- 已配置短信/邮件发送服务（验证码、通知）。
- 已部署认证服务与网关，启用 IP/设备指纹基础校验与限流策略。
- 已确定密码策略（长度/复杂度/尝试次数限制）与 2FA 可选策略。

## 4. 主流程（文本序列图）
1) 注册
- 访客在登录页选择“注册”，填写手机/邮箱与密码。
- 系统校验唯一性与强度，发送验证码（短信/邮件）。
- 用户提交验证码；系统校验通过后创建用户、默认角色、初始状态为 `active`（或 `pending_kyc`）。
- 系统签发 `AccessToken` 与 `RefreshToken`，创建会话与登录审计记录。

2) 登录
- 用户输入凭据（手机/邮箱 + 密码，或第三方 Code）。
- 系统校验账号状态（`active/locked/disabled`）、密码错误次数与风控策略（设备/IP）。
- 若启用 2FA，校验一次性验证码；成功后签发令牌并更新会话与审计。

3) 刷新
- 客户端在 `AccessToken` 临近过期时使用 `RefreshToken` 申请新令牌。
- 系统校验刷新令牌有效性与黑名单，签发新 `AccessToken` 并可旋转刷新令牌。

4) 登出
- 用户主动登出或服务端踢出会话，系统注销会话、加入令牌黑名单（软失效），记录审计。

## 5. 状态与事件
- 用户状态：`active`、`pending_kyc`、`locked`（连续失败/风控）、`disabled`（封禁）。
- 关键事件：`UserRegistered`、`UserLoggedIn`、`UserLoggedOut`、`UserLocked`、`UserDisabled`。

## 6. 接口映射（示例）
- `POST /api/auth/register` 注册
- `POST /api/auth/verify` 验证码校验
- `POST /api/auth/login` 登录
- `POST /api/auth/refresh` 刷新令牌
- `POST /api/auth/logout` 登出
- `GET  /api/auth/profile` 获取当前用户基本资料

## 7. 数据与校验
- 用户表唯一索引：`phone`、`email`；密码使用强哈希（如 `bcrypt`）与随机盐。
- 验证码：防刷限流、有效期 5-10 分钟、错误重试上限与黑名单机制。
- 2FA：基于 TOTP 或短信二次验证，异常设备/IP 触发强 2FA。
- 令牌：`AccessToken` 短时有效、`RefreshToken` 长时有效；支持旋转与黑名单。

## 8. 异常与回滚
- 重复账号：返回业务错误码并引导找回。
- 验证码过期/错误：失败计数与限流，异常触发风控。
- 登录失败过多：锁定账号到期自动解锁或管理员干预。
- 刷新令牌失效：强制重新登录，清理会话。

## 9. 审计与合规
- 审计字段：时间、IP、设备指纹、成功/失败原因、地理位置（粗粒度）。
- 合规：密码策略合规、个人信息保护（脱敏存储与传输），支持账号删除与数据导出。

## 10. 验收标准
- 注册/登录/刷新/登出端到端用例通过，覆盖手机/邮箱与第三方登录。
- 异常用例：验证码错误/过期、密码错误锁定、令牌失效均有明确提示与审计记录。
- 安全：OWASP 常见问题防护（暴力破解、会话固定、令牌窃取）。
- 体验：平均注册耗时 < 8s，登录耗时 < 3s，失败反馈清晰。