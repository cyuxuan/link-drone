# 019-供需匹配推荐主流程

本流程定义供需主任务的匹配推荐路径，兼顾地理约束、资质、排班与评分，确保结果可成交与可履约。

## 1. 目标与范围
- 提供高质量候选供给集，满足地理/时间/资质/预算等硬约束，并通过评分排序优化转化。
- 支持实时检索与离线更新相结合，保证时效与稳定性。

## 2. 参与角色
- 需求方：拉取推荐列表、挑选供给并发起订单创建。
- 供给方：被动纳入候选、接收撮合通知、设置接单策略（容量/时间）。
- 系统：匹配引擎、索引服务、缓存与事件总线。

## 3. 前置条件
- 已建立供给索引（地理、类目、资质、价格、评分、容量/排班）。
- 启用禁飞区与资质实时校验（到期/失效动态过滤）。

## 4. 主流程
1) 候选集生成
- 从索引检索满足硬约束（地理/时间/资质/预算）的供给项。
- 过滤不可接单（容量耗尽/排班冲突/临时下线）。

2) 评分与排序
- 综合评分：`相关性(地点/时间/类目) + 价格匹配度 + 服务质量(评分/履约率) + 响应速度 + 近似历史成功率`。
- 引入多臂赌博探索（适度曝光新优质供给）。

3) 列表返回与交互
- 返回分页列表与精简卡片信息（价格区间、评分、可服务时段、距离）。
- 支持快速筛选（价格/评分/距离/资质标签）。

4) 订阅与动态更新
- 需求方可订阅候选变化事件（`SupplyAvailabilityChanged`、`KycExpired`）。
- 候选变化时列表局部刷新，保障体验与正确性。

## 5. 状态与事件
- 状态：索引 `fresh/stale`；候选 `valid/invalid`（动态校验）。
- 事件：`MatchCandidatesRequested`、`CandidatesRecomputed`、`CandidateInvalidated`。

## 6. 接口映射（示例）
- `GET  /api/match/search` 按条件检索候选
- `POST /api/match/subscribe` 订阅候选变化（websocket/SSE）
- `GET  /api/match/item/{id}` 供给详情拉取（含近期可接单日程）

## 7. 数据与校验
- 索引：`supply_index`（地理、类目、资质、价格、评分、容量/排班标记）。
- 校验：资质有效期、禁飞区、预算匹配、排班/容量、黑名单过滤。

## 8. 异常与回滚
- 索引过期：触发增量重建与局部刷新；退回基础检索以保证可用。
- 候选失效：在订单创建前再次校验并提示替代候选。

## 9. 审计与合规
- 审计：检索条件、候选集大小、过滤原因分布、点击-下单转化率。
- 合规：推荐公平性与可解释性（显示关键匹配因素）。

## 10. 验收标准
- 关键约束下候选集质量与排序相关性达标（转化率/点击率提升）。
- 候选变化订阅与局部刷新可用；订单创建前二次校验生效。
- 压测下检索 P95 < 300ms、分页与筛选体验流畅。