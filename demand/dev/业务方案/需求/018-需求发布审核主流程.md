# 018-需求发布审核主流程

本流程细化需求方提出任务需求并发布的主路径，确保任务信息清晰、可执行、可撮合。

## 1. 目标与范围
- 定义需求模板（场景、时间窗、地点、预算、成果交付），提升规范性与可撮合性。
- 建立必要的审核与规则拦截，避免不合规需求流入撮合。
- 与匹配、订单创建、支付预付款等后续流程无缝衔接。

## 2. 参与角色
- 需求方：编写并提交任务需求。
- 审核员（运营）：核查合规性与可执行性，裁决发布与否。
- 系统：规则校验、索引写入、事件触发。

## 3. 前置条件
- 启用禁飞区、地理覆盖规则与时间窗校验（含缓冲）。
- 配置预算与类目模板，明确交付物与验收标准字段。

## 4. 主流程
1) 草稿与校验
- 需求方填写任务：服务类型、地点（坐标/范围）、时间窗、预算、交付物、补充说明。
- 系统进行校验：必填项、禁飞区、时间合理性、预算与类目匹配。

2) 提交审核
- 提交后状态为 `reviewing`，生成审核任务。
- 审核员核查合规与清晰度，不合格退回至 `resubmit_required` 并附改进建议。

3) 发布与索引
- 通过后状态 `approved`，自动 `published`（可撮合）；写入搜索与地理索引。
- 触发 `DemandPublished` 事件；可设置有效期与过期逻辑。

## 5. 状态与事件
- 状态机：`draft` → `reviewing` → `approved/rejected` → `published/unpublished` → `expired`。
- 事件：`DemandDrafted`、`DemandSubmitted`、`DemandReviewed`、`DemandPublished`、`DemandExpired`。

## 6. 接口映射（示例）
- `POST /api/demand/items` 创建草稿
- `PUT  /api/demand/items/{id}` 更新草稿
- `POST /api/demand/items/{id}/submit` 提交审核
- `POST /api/demand/items/{id}/publish` 发布

## 7. 数据与校验
- 模型：`demand_item`、`demand_constraints`（时间窗/地理范围/预算）、`demand_delivery`（交付定义）。
- 校验：禁飞区、时间窗与缓冲、预算与类目模板匹配、交付物描述清晰度评分。

## 8. 异常与回滚
- 信息不清：评分过低时退回并给出示例模板。
- 禁飞区冲突：强拦截，支持地点调整建议与风险提示。
- 超预算/不合类目：退回或建议拆分任务。

## 9. 审计与合规
- 审计：提交者、差异对比、审核者与裁决理由、合规风险标记。
- 合规：地点敏感信息处理、隐私保护、规范用语与内容合规。

## 10. 验收标准
- 草稿-审核-发布端到端用例通过，索引可搜索；
- 异常拦截（禁飞区、时间窗不合理、信息不清）反馈明确；
- 有效期与过期逻辑生效，撮合可订阅到发布事件。