# 025-即时通讯与系统通知主流程

本流程定义订单协作中即时通讯与系统通知的主路径，保障沟通效率与可追溯性。

## 1. 目标与范围
- 为订单沟通提供会话维度的即时消息（文本/图片/文件/定位）。
- 提供系统通知（状态变更、支付结果、日程提醒）与送达确认。

## 2. 参与角色
- 需求方/供给方：会话沟通与文件交换。
- 系统：推送通知、SSE/Websocket 连接管理、送达回执与重试。

## 3. 前置条件
- 消息服务与网关配置、存储与合规（内容审核与隐私）。
- 通知渠道就绪（站内、短信、邮件、APP 推送）。

## 4. 主流程
1) 会话建立
- 订单创建后自动建立会话；双方加入会话与权限控制。

2) 消息发送与接收
- 客户端通过长连接发送消息；系统写入消息存储并广播到对端。
- 失败重试与离线消息缓存；内容审核异步进行与拦截反馈。

3) 系统通知
- 订单状态变更、支付结果、日程提醒触发通知；多渠道送达与回执。
- 未送达重试与渠道切换；重要通知升级到短信/电话。

## 5. 状态与事件
- 状态：会话 `active`/`muted`/`closed`；消息 `sent`/`delivered`/`read`。
- 事件：`SessionCreated`、`MessageSent`、`Delivered`、`Read`、`NotificationPushed`。

## 6. 接口映射（示例）
- `POST /api/chat/sessions/{orderId}` 创建/获取会话
- `WS  /api/chat/connect` 建立长连接
- `POST /api/notify/push` 推送系统通知

## 7. 数据与校验
- 模型：`chat_session`、`chat_message`、`notification`、`receipt`。
- 校验：会话权限与订单绑定、内容审核（涉敏词/涉政/涉黄）、附件病毒扫描。

## 8. 异常与回滚
- 连接断开：自动重连与离线消息下发。
- 审核拦截：返回原因与处置建议，保留审计。

## 9. 审计与合规
- 审计：消息留痕、系统通知回执、涉敏内容处置。
- 合规：隐私与内容合规、最小化暴露与加密通道。

## 10. 验收标准
- 会话消息与系统通知主流程端到端通过；
- 内容审核与送达回执有效；异常处理与重试完善。