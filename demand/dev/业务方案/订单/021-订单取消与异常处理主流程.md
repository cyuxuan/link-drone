# 021-订单取消与异常处理主流程

本流程描述订单在创建至执行阶段可能发生的取消与异常的处理主路径，保障公平性、透明度与资金安全。

## 1. 目标与范围
- 明确取消政策（时间窗、扣费规则）与异常分类（天气、禁飞、设备故障、人员不可达）。
- 建立协商、申诉与仲裁机制，保障双方权益。

## 2. 参与角色
- 需求方/供给方：发起取消或异常上报，参与协商与处理。
- 运营与客服：介入争议处理与仲裁，维护平台公信力。

## 3. 前置条件
- 取消与异常规则配置（时间阈值、扣费比例、不可抗力界定）。
- 通知与消息通道畅通，记录证据链（图片/视频/日志）。

## 4. 主流程
1) 取消申请
- 发起方选择取消类型（主动变更、不可抗力、对方违约），填写理由与证据。
- 系统评估是否满足取消政策，计算预估扣费与退款金额。

2) 协商与确认
- 对方收到通知并可提出异议与证据；双方协商后形成一致意见。
- 未达成一致：升级客服仲裁，最终裁决扣费/退款方案。

3) 资金处理
- 根据裁决方案执行部分/全额退款或尾款豁免；记录资金审计与对账。

4) 订单状态变更
- 取消后订单状态 `cancelled`，保留履约记录与证据；如为异常中止，状态 `aborted`。

## 5. 状态与事件
- 状态：`created/accepted/prepaid/executing` → `cancelled/aborted`。
- 事件：`OrderCancelRequested`、`OrderCancelNegotiating`、`OrderCancelled`、`OrderAborted`、`RefundProcessed`。

## 6. 接口映射（示例）
- `POST /api/orders/{id}/cancel` 发起取消
- `POST /api/orders/{id}/dispute` 发起争议申诉
- `POST /api/orders/{id}/cancel/confirm` 协商确认
- `POST /api/orders/{id}/cancel/reject` 拒绝取消并提供证据

## 7. 数据与校验
- 模型：`order_cancel`、`order_dispute`、`order_evidence`、`order_refund`。
- 校验：政策匹配（时间窗、扣费比例）、证据有效性、双方举证时限。

## 8. 异常与回滚
- 恶意取消：风控标记与惩罚；必要时限制账户。
- 仲裁失败：升级为平台最终裁决；支持申诉后再裁决一次。

## 9. 审计与合规
- 审计：取消原因、协商过程、证据链、裁决与资金处理记录。
- 合规：不可抗力界定与透明化、申诉流程合规、用户隐私与证据保护。

## 10. 验收标准
- 多场景取消与异常中止用例通过（含不可抗力与违约）。
- 协商/仲裁路径清晰、资金处理准确、审计完整。
- 通知触达与进度更新及时，用户体验与规则透明度达标。