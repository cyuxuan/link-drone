# 020-订单创建确认执行主流程

本流程定义从匹配结果进入订单创建、确认与执行的主路径，确保可履约与体验一致。

## 1. 目标与范围
- 建立明确的订单状态机与关键校验点（资质/容量/时间/禁飞区）。
- 支持预付款后确认排班，并进入履约执行阶段。

## 2. 参与角色
- 需求方：发起订单创建、支付预付款、协同执行。
- 供给方：确认可接单、安排执行、更新进度。
- 系统/调度：校验与排班协调、通知与消息、状态推进。

## 3. 前置条件
- 匹配候选已二次校验通过（资质、容量、排班）。
- 支付策略与预付款比例配置就绪；消息通知通道可用。

## 4. 主流程
1) 订单创建
- 需求方选择供给，提交订单草案（需求摘要、时间窗、地点、价格约定）。
- 系统校验约束（禁飞区、资质、容量/排班）；创建订单 `created`。

2) 供给确认
- 供给方收到通知，确认 `accepted` 或拒绝 `rejected`（附理由、可替代建议）。
- 拒绝后需求方可选择下一候选或调整条件。

3) 预付款
- 确认后，系统生成支付单并引导需求方支付预付款；成功后订单转 `prepaid`。

4) 排班与执行
- 确认排班与准备工作；进入 `executing`，供给方按里程碑更新进度与交付物草稿。
- 中途如遇异常，参考取消与异常流程（021）。

5) 执行完成
- 达成交付条件后，订单进入 `executed`，等待验收与尾款结算（参见 024、022）。

## 5. 状态与事件
- 状态机：`created` → `accepted/rejected` → `prepaid` → `executing` → `executed` → `completed`。
- 事件：`OrderCreated`、`OrderAccepted`、`PrepaidReceived`、`OrderExecuting`、`OrderExecuted`。

## 6. 接口映射（示例）
- `POST /api/orders` 创建订单
- `POST /api/orders/{id}/accept` 接单
- `POST /api/orders/{id}/reject` 拒单
- `POST /api/orders/{id}/prepay` 预付款
- `POST /api/orders/{id}/start` 开始执行
- `POST /api/orders/{id}/progress` 更新进度

## 7. 数据与校验
- 模型：`order`、`order_items`、`order_schedule`、`order_progress`、`order_payment`。
- 校验：二次校验禁飞区/资质/容量、预算一致性、时窗冲突、黑名单过滤。

## 8. 异常与回滚
- 拒单：回退到候选选择；保留沟通与建议。
- 预付款失败：保留 `accepted` 状态，提醒补付或超时取消。
- 执行中异常：暂停与变更协商，必要时触发争议与取消流程。

## 9. 审计与合规
- 审计：订单关键信息、确认人、时间、进度变更留痕；消息通知送达记录。
- 合规：履约记录、位置与轨迹合规存储（必要字段脱敏）。

## 10. 验收标准
- 订单创建-确认-预付-执行闭环用例通过；
- 关键校验与状态机推进正确；通知与消息触达可靠；
- 异常用例（拒单、预付失败、执行异常）均有清晰回退与提示。