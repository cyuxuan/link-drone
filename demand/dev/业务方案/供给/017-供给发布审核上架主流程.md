# 017-供给发布审核上架主流程

本流程细化供给方创建服务项、提交审核并上架的主路径，确保平台供给质量与可交易性。

## 1. 目标与范围
- 支持供给方按类目模板发布服务项（航拍、测绘、巡检等）。
- 通过审核机制与规则校验，保证信息真实、资质有效、定价合规。
- 与撮合、订单、支付闭环打通，上架后可被搜索与匹配。

## 2. 参与角色
- 供给方（商家/飞手）：编写并提交供给服务项。
- 审核员（运营）：校验信息与资质、裁决上架与否。
- 系统：规则校验（必填、类目、资质、LBS）、索引更新、事件通知。

## 3. 前置条件
- 供给方通过实名与资质认证，设备证书与飞手证齐备。
- 类目模板与定价策略配置完成，启用禁飞区与地点可服务范围规则。

## 4. 主流程
1) 草稿与校验
- 供给方在后台填写服务项：标题、描述、类目、资质、设备、定价、可服务区域、日程排班。
- 系统进行规则校验：必填项、图片视频清晰度、类目兼容性、资质有效期、禁飞区冲突。

2) 提交审核
- 供给方提交，状态转为 `reviewing`，生成审核任务。
- 审核员复核描述、资质、样例作品等，必要时补充问询。

3) 审核裁决
- 通过：状态 `approved`，根据排班与配置自动设为 `published`（上架）。
- 驳回：状态 `rejected`，给出具体问题与建议，供给方修改后可再次提交。

4) 上架与索引
- 上架后写入搜索索引与地理索引，更新缓存；触发 `SupplyPublished` 事件供撮合订阅。
- 支持按库存/容量与日程自动上下架（`capacity_exhausted` → `unavailable`）。

## 5. 状态与事件
- 状态机：`draft` → `reviewing` → `approved/rejected` → `published/unpublished` → `unavailable`。
- 事件：`SupplyDrafted`、`SupplySubmitted`、`SupplyReviewed`、`SupplyPublished`、`SupplyUnpublished`。

## 6. 接口映射（示例）
- `POST /api/supply/items` 创建草稿
- `PUT  /api/supply/items/{id}` 更新草稿
- `POST /api/supply/items/{id}/submit` 提交审核
- `POST /api/supply/items/{id}/publish` 上架
- `POST /api/supply/items/{id}/unpublish` 下架

## 7. 数据与校验
- 模型：`supply_item`、`supply_pricing`、`supply_capacity`、`supply_schedule`、`supply_media`。
- 校验：资质有效期、禁飞区、地理覆盖、类目与模板一致性、定价与最小单位合法性。

## 8. 异常与回滚
- 资质过期：拦截审核/上架；提醒升级/续期。
- 媒体不合规：驳回与整改；保留草稿与差异对比。
- 容量耗尽：自动下架或置为不可售，恢复后自动上架。

## 9. 审计与合规
- 审计：提交者、审核者、时间、差异内容、裁决理由与证据。
- 合规：类目合规与资质必备项、版权合法性、媒体内容规范。

## 10. 验收标准
- 草稿-审核-上架端到端用例通过，含类目与资质校验。
- 索引与可搜索性验证通过；容量与排班联动上下架工作正常。
- 异常用例（驳回、资质过期、禁飞区冲突）均有明确反馈与审计。